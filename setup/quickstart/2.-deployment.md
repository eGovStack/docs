# 2. Deployment

## **DIGIT Deployment on k3d**

Now that we have the Infra setup to proceed with the DIGIT Deployment. Following are the tools that need to be installed on the machine before proceeding with the DIGIT Services deployment.

**What we'll deploy in Quickstart:**

* DIGIT's core platform services
* PGR

### **Prerequisites**

1. DIGIT uses [golang](https://golang.org/doc/install#download) (required v1.13.3) automated scripts to deploy the builds on to Kubernetes - [Linux](https://golang.org/dl/go1.13.3.linux-amd64.tar.gz) or [Windows](https://golang.org/dl/go1.13.3.windows-amd64.msi) or [Mac](https://golang.org/dl/go1.13.3.darwin-amd64.pkg)
2. All DIGIT services are packaged using helm charts[ ![](https://helm.sh/img/favicon-152.png)Installing Helm](https://helm.sh/docs/intro/install/)
3. [kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/) is a CLI to connect to the kubernetes cluster from your machine
4. Install [CURL](https://help.ubidots.com/en/articles/2165289-learn-how-to-install-run-curl-on-windows-macosx-linux) for making api calls
5. [Install Visualstudio](https://code.visualstudio.com/download) IDE Code for better code/configuration editing capabilities
6. [Install Postman](https://www.postman.com/downloads/) to run digit bootstrap scripts

### Prepare Deployment Configs

1. Clone the following [GitRepo](https://github.com/egovernments/DIGIT-DevOps), you may need to [install git](https://docs.github.com/en/github/creating-cloning-and-archiving-repositories/cloning-a-repository-from-github/cloning-a-repository) and then run [git clone](https://docs.github.com/en/github/creating-cloning-and-archiving-repositories/cloning-a-repository-from-github/cloning-a-repository) it to your machine.
   * ```
     root@ip:/# git clone -b quickstart https://github.com/egovernments/DIGIT-DevOps 
     ```
2. After cloning the repo CD into the folder DIGIT-DevOps and type the "code ." command that will open the visual editor and opens all the files from the repo DIGIT-DevOps
   * ```
     root@ip:/# cd DIGIT-DevOps
     root@ip:DIGIT-DevOps# code .
     ```
3. Create your deployment config file, you can use the following template  [sample deployment config file](https://github.com/egovernments/DIGIT-DevOps/blob/quickstart/deploy-as-code/helm/environments/quickstart-config.yaml) and update the required details if needed. (For a quick start you can run as it is)
   1. ```
      https://github.com/egovernments/DIGIT-DevOps/blob/quickstart/deploy-as-code/helm/environments/quickstart-config.yaml
      ```
4. Add the following entries in your host file /etc/hosts depending on your OS, instructions can be found below.
   * [ ] [Ubuntu](http://manpages.ubuntu.com/manpages/trusty/man5/hosts.5.html)
   * [ ] [Windows](https://www.groovypost.com/howto/edit-hosts-file-windows-10/)
   * [ ] [MacOS](https://www.imore.com/how-edit-your-macs-hosts-file-and-why-you-would-want#page1)
5. When you find it, add following lines to the hosts file, save and close the file.
   * `127.0.0.1 quickstart.local.digit`

### Deployment

Now we have all the deployments configs ready, we can now run the following command and provide the necessary details asked and this interactive installer will take care of the rest.

1. Run the egov-deployer go script&#x20;

```
root@ip:# cd DIGIT-DevOps/deploy-as-code/egov-deployer

root@ip:# go run digit_setup.go

#Be prepared for the following questions
1. Do you have the Kubernetes Setup?
2. Provide the path of the intented env kubeconfig file
3. Which version of the DIGIT that you want to install - Choose "Quickstart"
4. What DIGIT Modules that you choose to install
5. All, done, Now do you want to preview the deployment manifests 
6. Are you good to proceed with the DIGIT Installation

All Done.
```

2\. You can now test the Digit application status in command prompt/terminal by using the below command.

```
curl -Is http://quickstart.local.digit/employee/login |  head -n 1

OutPut:
HTTP/2 200
```

**Note**: Initially pgr-services would be in crashloopbackoff state, but after performing below Post Deployment Steps pgr-services will start running.&#x20;

## 3. Post Deployment Steps

Post deployment, now the application will be accessible from the configured domain.

To try out PGR employee login, Lets create a sample tenant, city, user to login and assign LME employee role through the seed script

1. We have to do the [kubectl port-forwarding](https://phoenixnap.com/kb/kubectl-port-forward) of the **egov-user** service running from kubernetes cluster to your localhost, this will now give you access to egov-user service directly and interact with the api directly.

```
kubectl port-forward svc/egov-user 8080:8080 -n egov
Forwarding from 127.0.0.1:8080 -> 8080
Forwarding from [::1]:8080 -> 8080
```

2\. Seed the sample data

* Ensure you have the postman to run the following seed data api, if not [Install postman](https://www.postman.com/downloads/canary/) on your local
* Import the following postman collection into the postman and run it, this will have the seed data that enable sample test users and localisation data.
  * [DIGIT Bootstrap](https://raw.githubusercontent.com/egovernments/DIGIT-DevOps/quickstart/deploy-as-code/bootstrap\_scripts/seed\_data.json)

![](<../../.gitbook/assets/image (112) (1).png>)

![](<../../.gitbook/assets/image (113) (1).png>)

To test the kubernetes operations through kubectl from you local machine, please execute the below commands.

```bash
#get the pods running in the cluster
kubectl get pods -n egov

Output:

NAME                                                    READY   STATUS    RESTARTS   AGE
citizen-79cf89659c-8glf4                                1/1     Running   0          14d
egov-accesscontrol-78b78dddb9-tfbkf                     1/1     Running   0          21d
egov-enc-service-574cd7b5b5-hmhh4                       1/1     Running   0          36d
egov-idgen-84954b565b-xsnqj                             1/1     Running   0          45d
egov-indexer-5f5fbb6f4b-58rtm                           1/1     Running   0          43d
egov-localization-6cc5977bb9-gm7f9                      1/1     Running   0          27d
egov-mdms-service-65d6d65d8c-t85d9                      1/1     Running   0          21d
egov-user-6676968d76-8n6t6                              1/1     Running   0          29d
egov-workflow-v2-5cdb96bcf5-dcgmf                       1/1     Running   0          36d
employee-749464fbfb-tptlh                               1/1     Running   0          14d
nginx-ingress-controller-b9678869c-mkslb                1/1     Running   0          49d
pgr-services-b9f4ffdbf-5h5kd                            1/1     Running   0          38d
zuul-788bf8cd8b-9nxfl                                   1/1     Running   0          41d


#Delete the pods so that it gets restarted automatically

kubectl delete pods zuul-788bf8cd8b-9nxfl egov-workflow-v2-5cdb96bcf5-dcgmf pgr-services-b9f4ffdbf-5h5kd -n egov

Output:

pod "zuul-788bf8cd8b-9nxfl" deleted
pod "egov-workflow-v2-5cdb96bcf5-dcgmf" deleted
pod "pgr-services-b9f4ffdbf-5h5kd" deleted
```

You have successfully completed the DIGIT Infra, Deployment setup and Installed a DIGIT - PGR module.

{% hint style="info" %}
You can try experimenting the different DIGIT modules by installing them in your cluster with your H/W or VM complying to higher level machine configuration of increased number of vCPUs. RAM and storage size.
{% endhint %}
